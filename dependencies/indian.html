<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player</title>
</head>

<body style="
  margin:0;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
">

<video
  id="video"
  controls
  playsinline
  style="width:90vw;max-width:600px;background:#000;"
></video>

<script>
const params = new URLSearchParams(location.search);
const q = params.get("q");
const d = "xxxbp.tv";

if (!q) {
  document.body.insertAdjacentHTML(
    "beforeend",
    "<p style='color:#fff'>Missing video ID.</p>"
  );
  throw new Error("Missing q");
}

const video = document.getElementById("video");

async function fetchStream() {
  const r = await fetch(`https://api.${d}/hls`, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `id=${encodeURIComponent(q)}`
  });

  const j = await r.json();
  return j.master || (Array.isArray(j.mp4) && j.mp4[0]?.src) || null;
}

(async () => {
  const src = await fetchStream();

  if (!src) {
    alert("Failed to load video");
    return;
  }

  video.src = src;

  // iOS requires a user gesture, controls satisfy that
  video.addEventListener("loadedmetadata", () => {
    video.play().catch(() => {});
  });
})();
</script>

</body>
</html>
